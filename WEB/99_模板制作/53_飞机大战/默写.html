<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <style>
        *{
            margin:0;
            padding:0;
        }
    </style>
</head>
<body>
<canvas id="canvas" width="500" height="500">
    低版本浏览器不支持
</canvas>
<script type="text/javascript">
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    canvas.width = document.documentElement.clientWidth;
    canvas.height = document.documentElement.clientHeight;

    function loading(obj,progress,fun) {
        var imgCount = 0;
        for ( var i in obj){
            imgCount++;
        }
        var count = 0;
        var imgsObj = {};

        for (var prop in obj){
            var img = new Image();
            img.src = obj[prop];

            img.onload = (function (attr) {
                return function () {
                    count++;
                    progress((count/imgCount).toFixed(2)*100+"%");

                    imgsObj[attr] = this;

                    if (count == imgCount){
                        fun(imgsObj);
                    }
                }
            })(prop)
        }
    }

    loading({"background_2":"img/background_2.png","bg1":"img/bg1.png","bomb":"img/bomb.png","bullet1":"img/bullet1.png","bullet2":"img/bullet2.png","enemy1_blowup_1":"img/enemy1_blowup_1.png","enemy1_blowup_2":"img/enemy1_blowup_2.png","enemy1_blowup_3":"img/enemy1_blowup_3.png","enemy1_blowup_4":"img/enemy1_blowup_4.png","enemy1_fly_1":"img/enemy1_fly_1.png","enemy2_blowup_1":"img/enemy2_blowup_1.png","enemy2_blowup_2":"img/enemy2_blowup_2.png","enemy2_blowup_3":"img/enemy2_blowup_3.png","enemy2_blowup_4":"img/enemy2_blowup_4.png","enemy2_blowup_5":"img/enemy2_blowup_5.png","enemy2_blowup_6":"img/enemy2_blowup_6.png","enemy2_blowup_7":"img/enemy2_blowup_7.png","enemy2_fly_1":"img/enemy2_fly_1.png","enemy2_fly_2":"img/enemy2_fly_2.png","enemy2_hit_1":"img/enemy2_hit_1.png","enemy3_blowup_1":"img/enemy3_blowup_1.png","enemy3_blowup_2":"img/enemy3_blowup_2.png","enemy3_blowup_3":"img/enemy3_blowup_3.png","enemy3_blowup_4":"img/enemy3_blowup_4.png","enemy3_fly_1":"img/enemy3_fly_1.png","enemy3_hit_1":"img/enemy3_hit_1.png","enemy3_hit_2":"img/enemy3_hit_2.png","enemy4_fly_1":"img/enemy4_fly_1.png","enemy5_fly_1":"img/enemy5_fly_1.png","gameArts-hd":"img/gameArts-hd.png","gameArts":"img/gameArts.png","game_pause":"img/game_pause.png","game_pause_hl":"img/game_pause_hl.png","hero_blowup_1":"img/hero_blowup_1.png","hero_blowup_2":"img/hero_blowup_2.png","hero_blowup_3":"img/hero_blowup_3.png","hero_blowup_4":"img/hero_blowup_4.png","hero_fly_1":"img/hero_fly_1.png","hero_fly_2":"img/hero_fly_2.png","loading0":"img/loading0.png","loading1":"img/loading1.png","loading2":"img/loading2.png","loading3":"img/loading3.png"},function(a) {
                //图片加载的进度
                console.log(a);
            },main
    );

    function main(imgobj) {

        //英雄飞机
        var hero = {

            img: imgobj.hero_fly_1,
            w: imgobj.hero_fly_1.width,
            h: imgobj.hero_fly_1.height,
            x: (canvas.width-imgobj.hero_fly_1.width)/2,
            y: (canvas.height - imgobj.hero_fly_1.height - 20)

        };

        hero.draw = function () {
            ctx.drawImage(this.img,this.x,this.y,this.w,this.h);
        };

        //子弹
        function Bullet() {
            this.img = imgobj.bullet1;
            this.w = this.img.width;
            this.h = this.img.height;
            this.x = hero.x + hero.w/2 - this.w/2;
            this.y = hero.y - this.h;
            this.speed = 10;
        }

        Bullet.prototype.draw = function () {
            ctx.drawImage(this.img,this.x,this.y,this.w,this.h);
        };

        Bullet.prototype.move = function () {
            this.y -= this.speed;
        };
        var bullets = [];
        
        //敌机
        function rand(min,max) {
            return Math.floor(Math.random()*(max+1-min)+min);
        }

        function Enemy() {
            this.img = imgobj.enemy1_fly_1;
            this.w = this.img.width;
            this.h = this.img.height;
            this.x = rand(0,canvas.width-this.w);
            this.y = -this.h;
            this.speed = 1;
        }

        Enemy.prototype.draw = function () {
            ctx.drawImage(this.img,this.x,this.y,this.w,this.h);
        };

        Enemy.prototype.move = function () {
            this.y += this.speed;
        };
        function checkP(obj1,obj2) {
            var obj1x = obj1.x + obj1.w/2;
            var obj1y = obj1.y + obj1.h/2;
            var obj2x = obj2.x + obj2.w/2;
            var obj2y = obj2.y + obj2.h/2;

            var px = Math.abs(obj1x-obj2x);
            var py = Math.abs(obj1y-obj2y);

            if (px <= obj1.w/2+obj2.w/2 && py <= obj1.h/2 + obj2.h/2){
                return true;
            }else{
                return false;
            }
        }
        var enemys = [];

        var scrollY = 0;
        var time = 0;
        var canMove = false;
		var scores = 0;
        function run() {

            ctx.clearRect(0,0,canvas.width,canvas.height);

            scrollY++;
            time++;
            if (scrollY >= canvas.height){
                scrollY =0;
            }
            ctx.drawImage(imgobj.bg1,0,scrollY,canvas.width,canvas.height);
            ctx.drawImage(imgobj.bg1,0,-canvas.height+scrollY,canvas.width,canvas.height);


            if (time%10){
                hero.img = imgobj.hero_fly_1;
            }else{
                hero.img = imgobj.hero_fly_2;
            }
            hero.draw();


            if (time%10 ==0 ){
                var bullet = new Bullet();
                bullets.push(bullet);
            }
            for (var i = 0; i < bullets.length; i++){
                var bullet = bullets[i];
                bullet.draw();
                bullet.move();

                if (bullet.y <= -bullet.h){
                    bullets.splice(i,1);
                    i--;
                }
            }

            if (time%50 ==0 ){
                var enemy = new Enemy();
                enemys.push(enemy);
            }
            for (var i = 0; i < enemys.length; i++){
                var enemy = enemys[i];
                enemy.draw();
                enemy.move();

                if (enemy.y >= canvas.height){
                    enemys.splice(i,1);
                    i--;
                }
            }
            
            for(var i = 0; i < bullets.length; i++){
            	for (var j = 0; j < enemys.length; j++) {
            		if (checkP(bullets[i],enemys[j])) {
            			scores += 10;
            			bullets.splice(i,1);
            			enemys.splice(j,1);
            		}
            	}
            }
            ctx.font = "1.5em STXingkai-SC-Light";
    		ctx.fillStyle = "blue";
    		ctx.fillText("当前得分："+scores,10,30);
			
            window.requestAnimationFrame(run);


        }
        run();

        var MX,MY;
        document.addEventListener("touchstart",function (e) {
            var touch = e.touches[0];

            var TX = touch.clientX;
            var TY = touch.clientY;

            MX = TX - hero.x;
            MY = TY - hero.y;

            if (TX >= hero.x && TX <= hero.x + hero.w && TY >= hero.y && TY <= hero.y + hero.h){
                canMove = true;
            }
        });
        document.addEventListener("touchmove",function (e) {
            if (canMove){
                var touch = e.touches[0];

                var TX = touch.clientX;
                var TY = touch.clientY;

                hero.x = TX - MX;
                hero.y = TY - MY;

                if (hero.x <= 0){
                    hero.x = 0;
                }
                if (hero.x >= canvas.width - hero.w){
                    hero.x = canvas.width - hero.w;
                }
                if (hero.y <= 0){
                    hero.y = 0;
                }
                if (hero.y >= canvas.height - hero.h){
                    hero.y = canvas.height - hero.h;
                }
            }
        });
        document.addEventListener("touchend",function () {
            canMove = false;
        })
    }
    document.addEventListener("touchmove",function (e) {
        e.preventDefault();
    },false);



</script>
</body>
</html>